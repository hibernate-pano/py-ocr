# Py OCR 服务设计文档

## 1. 系统架构

### 1.1 整体架构
```
+-------------+     +-------------+     +--------------+
|             |     |             |     |              |
| Client/用户  +---->+ Flask API   +---->+ Celery Queue |
|             |     |             |     |              |
+-------------+     +-------------+     +--------------+
                          |                    |
                          v                    v
                   +-----------+        +-------------+
                   |           |        |             |
                   | SQLite DB |        | OCR Worker  |
                   |           |        |             |
                   +-----------+        +-------------+
                                             |
                                             v
                                    +----------------+
                                    |                |
                                    | MinIO Storage  |
                                    |                |
                                    +----------------+
```

### 1.2 核心组件
- **Flask API**: 提供RESTful API接口
- **Celery Queue**: 异步任务队列
- **SQLite DB**: 存储任务状态和结果
- **OCR Worker**: 处理OCR识别任务
- **MinIO Storage**: 对象存储服务

## 2. 项目结构

### 2.1 目录结构
```
py-ocr/
├── app/                    # 应用主目录
│   ├── api/               # API接口层
│   │   ├── __init__.py
│   │   └── routes.py     # API路由定义
│   ├── config/           # 配置层
│   │   ├── __init__.py
│   │   ├── config.py    # 配置类
│   │   └── logging_config.py  # 日志配置
│   ├── models/           # 数据模型层
│   │   ├── __init__.py
│   │   └── task.py      # 任务模型
│   ├── services/         # 服务层
│   │   ├── __init__.py
│   │   ├── minio_service.py  # MinIO服务
│   │   └── ocr_service.py    # OCR服务
│   ├── tasks/            # 任务层
│   │   ├── __init__.py
│   │   └── ocr_task.py  # Celery任务
│   └── utils/           # 工具层
│       └── __init__.py
├── tests/               # 测试目录
│   ├── __init__.py
│   ├── test_api.py     # API测试
│   └── test_ocr_service.py  # OCR服务测试
├── .env                # 环境变量
├── .env.example        # 环境变量示例
├── app.py             # 应用入口
├── celery_worker.py   # Celery工作进程
└── requirements.txt   # 项目依赖
```

### 2.2 分层设计
1. **API层**: 处理HTTP请求和响应
2. **服务层**: 实现业务逻辑
3. **模型层**: 定义数据结构和存储
4. **任务层**: 处理异步任务
5. **配置层**: 管理应用配置
6. **工具层**: 提供通用工具函数

## 3. 设计原则

### 3.1 SOLID原则应用
1. **单一职责原则 (SRP)**
   - 每个服务类只负责一个特定功能
   - OCRService专注于文本识别
   - MinioService专注于文件存储

2. **开放封闭原则 (OCP)**
   - 服务类设计为可扩展
   - 配置系统支持不同环境

3. **接口隔离原则 (ISP)**
   - API接口清晰分离
   - 服务接口功能单一

4. **依赖倒置原则 (DIP)**
   - 高层模块不依赖低层模块
   - 通过配置实现依赖注入

### 3.2 设计模式应用
1. **单例模式**
   - MinioService
   - OCRService
   - 配置管理

2. **工厂模式**
   - 应用创建（create_app）
   - 配置加载

3. **策略模式**
   - 文件处理策略（PDF/图片）
   - 配置策略（开发/生产）

## 4. 关键流程

### 4.1 文件上传流程
1. 客户端上传文件到API
2. API验证文件并生成任务ID
3. 保存文件到临时目录
4. 创建异步任务
5. 返回任务ID给客户端

### 4.2 OCR处理流程
1. Celery Worker接收任务
2. OCR服务处理文件
3. 结果保存到MinIO
4. 更新任务状态
5. 清理临时文件

### 4.3 状态查询流程
1. 客户端请求任务状态
2. 查询数据库获取状态
3. 返回状态信息（处理中/完成/失败）

## 5. 安全考虑

### 5.1 文件安全
- 文件大小限制
- 文件类型验证
- 安全的文件名处理
- 临时文件自动清理

### 5.2 存储安全
- MinIO访问控制
- 预签名URL
- 数据库访问控制

### 5.3 API安全
- 输入验证
- 错误处理
- 日志记录

## 6. 扩展性考虑

### 6.1 水平扩展
- 多Worker部署
- Redis集群
- MinIO集群

### 6.2 功能扩展
- 支持更多文件格式
- 自定义OCR参数
- 批量处理
- 结果回调

## 7. 监控和维护

### 7.1 日志系统
- 应用日志
- 错误日志
- 访问日志

### 7.2 性能监控
- 任务队列监控
- API性能监控
- 资源使用监控

## 8. 测试策略

### 8.1 单元测试
- API测试
- 服务测试
- 模型测试

### 8.2 集成测试
- 端到端测试
- 性能测试
- 负载测试 